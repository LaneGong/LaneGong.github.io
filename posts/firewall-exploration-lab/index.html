<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Linux防火墙实验 - Lane-诶嘿! Welcome~~</title><meta name="author" content="Lane Gong">
<meta name="author-link" content="https://github.com/LaneGong">
<meta name="description" content="SeedLab网络安全防火墙实验过程记录整理，对防火墙的理解还是比较浅层，在做的过程中有些仍没把握可能存在些许问题，欢迎指正和探讨！" /><meta name="keywords" content='网络安全攻防实验, Network' /><meta itemprop="name" content="Linux防火墙实验">
<meta itemprop="description" content="SeedLab网络安全防火墙实验过程记录整理，对防火墙的理解还是比较浅层，在做的过程中有些仍没把握可能存在些许问题，欢迎指正和探讨！"><meta itemprop="datePublished" content="2023-02-24T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-02-24T00:00:00+00:00" />
<meta itemprop="wordCount" content="7255"><meta itemprop="image" content="http://lanegong.top/logo.png"/>
<meta itemprop="keywords" content="网络安全攻防实验,Network," /><meta property="og:title" content="Linux防火墙实验" />
<meta property="og:description" content="SeedLab网络安全防火墙实验过程记录整理，对防火墙的理解还是比较浅层，在做的过程中有些仍没把握可能存在些许问题，欢迎指正和探讨！" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://lanegong.top/posts/firewall-exploration-lab/" /><meta property="og:image" content="http://lanegong.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-24T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://lanegong.top/logo.png"/>

<meta name="twitter:title" content="Linux防火墙实验"/>
<meta name="twitter:description" content="SeedLab网络安全防火墙实验过程记录整理，对防火墙的理解还是比较浅层，在做的过程中有些仍没把握可能存在些许问题，欢迎指正和探讨！"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://lanegong.top/posts/firewall-exploration-lab/" /><link rel="prev" href="http://lanegong.top/posts/rsa-public-key-encryption-and-signature-lab/" /><link rel="next" href="http://lanegong.top/posts/secure_intelligent_traffic_light_control_using_fog_computing/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Linux防火墙实验",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/lanegong.top\/posts\/firewall-exploration-lab\/"
    },"genre": "posts","keywords": "网络安全攻防实验, Network","wordcount":  7255 ,
    "url": "http:\/\/lanegong.top\/posts\/firewall-exploration-lab\/","datePublished": "2023-02-24T00:00:00+00:00","dateModified": "2023-02-24T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": "Lane","logo": {
          "@type": "ImageObject",
          "url": "http:\/\/lanegong.top\/images\/avatar.jpeg",
          "width":  690 ,
          "height":  684 
        }},"author": {
        "@type": "Person",
        "name": "Lane Gong"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Lane-诶嘿! Welcome~~"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.jpeg"
    data-srcset="/images/avatar.jpeg, /images/avatar.jpeg 1.5x, /images/avatar.jpeg 2x"
    data-sizes="auto"
    alt="Lane-诶嘿! Welcome~~"
    title="Lane-诶嘿! Welcome~~" width="690" height="684"/><span class="header-title-text">Lane の Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item has-children">
              <a
                class="menu-link"
                href="/posts/"
                title="查看所有文章"
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
                <ul class="sub-menu">
                  <li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="/categories/"
                          
                          
                        ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="/tags/"
                          
                          
                        ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/fun/"
                title="正在开发中..."
                
              ><i class="fa-solid fa-fan fa-fw fa-sm" aria-hidden="true"></i> 趣味</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/guides/"
                title="常用站点指南"
                
              ><i class="fa-solid fa-subway fa-fw fa-sm" aria-hidden="true"></i> 站点导航</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Lane-诶嘿! Welcome~~"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.jpeg"
    data-srcset="/images/avatar.jpeg, /images/avatar.jpeg 1.5x, /images/avatar.jpeg 2x"
    data-sizes="auto"
    alt="/images/avatar.jpeg"
    title="/images/avatar.jpeg" width="690" height="684"/><span class="header-title-text">Lane の Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><span class="nested-item">
                  <a
                    class="menu-link"
                    href="/posts/"
                    title="查看所有文章"
                    
                  ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a>
                  <i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden="true"></i>
                </span>
                <ul class="sub-menu">
                  <li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="/categories/"
                          
                          
                        ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="/tags/"
                          
                          
                        ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/fun/"
                  title="正在开发中..."
                  
                ><i class="fa-solid fa-fan fa-fw fa-sm" aria-hidden="true"></i> 趣味</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/guides/"
                  title="常用站点指南"
                  
                ><i class="fa-solid fa-subway fa-fw fa-sm" aria-hidden="true"></i> 站点导航</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>Linux防火墙实验</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/LaneGong" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.jpeg"
    data-srcset="/images/avatar.jpeg, /images/avatar.jpeg 1.5x, /images/avatar.jpeg 2x"
    data-sizes="auto"
    alt="Lane Gong"
    title="Lane Gong" width="690" height="684"/>&nbsp;Lane Gong</a></span>
          <span class="post-category">收录于 <a href="/categories/seedlab/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> SeedLab</a></span></div>
      <div class="post-meta-line"><span title=2023-02-24&#32;00:00:00><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-02-24">2023-02-24</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 7255 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 15 分钟</span>&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="Linux防火墙实验">
            <i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#environment-setup-using-containers">Environment Setup Using Containers</a></li>
    <li><a href="#task-1-implementing-a-simple-firewall">Task 1: Implementing a Simple Firewall</a>
      <ul>
        <li><a href="#a-implement-a-simple-kernel-module">A: Implement a Simple Kernel Module</a></li>
        <li><a href="#b-implement-a-simple-firewall-using-netfilter">B: Implement a Simple Firewall Using Netfilter</a>
          <ul>
            <li><a href="#task1">Task1</a></li>
            <li><a href="#task2">Task2</a></li>
            <li><a href="#task3">Task3</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#task-2-experimenting-with-stateless-firewall-rules">Task 2: Experimenting with Stateless Firewall Rules</a>
      <ul>
        <li><a href="#a-protecting-the-router">A: Protecting the Router</a></li>
        <li><a href="#b-protecting-the-internal-network">B: Protecting the Internal Network</a></li>
        <li><a href="#c-protecting-internal-servers">C: Protecting Internal Servers</a></li>
      </ul>
    </li>
    <li><a href="#task-3-connection-tracking-and-stateful-firewall">Task 3: Connection Tracking and Stateful Firewall</a>
      <ul>
        <li><a href="#a-experiment-with-the-connection-tracking">A: Experiment with the Connection Tracking</a></li>
        <li><a href="#b-setting-up-a-stateful-firewall">B: Setting Up a Stateful Firewall</a></li>
      </ul>
    </li>
    <li><a href="#task-4-limiting-network-traffic">Task 4: Limiting Network Traffic</a></li>
    <li><a href="#task-5-load-balancing">Task 5: Load Balancing</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>SeedLab网络安全防火墙实验过程记录整理，对防火墙的理解还是比较浅层，在做的过程中有些仍没把握可能存在些许问题，欢迎指正和探讨！</p>
<blockquote>
<p>实验来源：<a href="https://github.com/seed-labs/seed-labs"target="_blank" rel="external nofollow noopener noreferrer">seed-labs</a></p>
<p>实验环境：SEEDUbuntu 20.04 VM</p>
</blockquote>
<h2 id="environment-setup-using-containers">Environment Setup Using Containers</h2>
<p>命令：<code>docker-compose up -d</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230208000916665.png"
    data-srcset="/images/image-20230208000916665.png, /images/image-20230208000916665.png 1.5x, /images/image-20230208000916665.png 2x"
    data-sizes="auto"
    alt="image-20230208000916665"
    title="image-20230208000916665" width="1054" height="230"/></p>
<h2 id="task-1-implementing-a-simple-firewall">Task 1: Implementing a Simple Firewall</h2>
<h3 id="a-implement-a-simple-kernel-module">A: Implement a Simple Kernel Module</h3>
<p>LKM allows us to add a new module to the kernel at the runtime. This new module enables us to extend the functionalities of the kernel, without rebuilding the kernel or even rebooting the computer. The packet filtering part of a firewall can be implemented as an LKM. In this task, we will get familiar with LKM. <strong>The following is a simple loadable kernel module. It prints out &ldquo;Hello World!&rdquo; when the module is loaded; when the module is removed from the kernel, it prints out &ldquo;Bye-bye World!&rdquo;.</strong> The messages are not printed out on the screen; they are actually printed into the /var/log/syslog file. You can use &ldquo;dmesg&rdquo; to view the messages.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//Labsetup/Files/kernel_module/hello.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">initialization</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Hello World!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Bye-bye World!.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module_init</span><span class="p">(</span><span class="n">initialization</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We now need to create Makefile, which includes the following contents. Just type make, and the above program will be compiled into a loadable kernel module.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">+=</span> hello.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译内核模块：
<img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211094607549.png"
    data-srcset="/images/image-20230211094607549.png, /images/image-20230211094607549.png 1.5x, /images/image-20230211094607549.png 2x"
    data-sizes="auto"
    alt="image-20230211094607549"
    title="image-20230211094607549" width="1030" height="465"/></p>
<p>生成的内核模块为hello.ko，可以使用下述命令进行模块加载、展示、移除等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ sudo insmod hello.ko <span class="o">(</span>inserting a module<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ lsmod <span class="p">|</span> grep hello <span class="o">(</span>list modules<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ sudo rmmod hello <span class="o">(</span>remove the module<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ dmesg <span class="o">(</span>check the messages<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ modinfo hello.ko <span class="o">(</span>show information about a Linux Kernel module<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在VM上运行该模块：</p>
<ol>
<li>
<p>往运行时内核插入该模块： <code>sudo insmod hello.ko</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211095257088.png"
    data-srcset="/images/image-20230211095257088.png, /images/image-20230211095257088.png 1.5x, /images/image-20230211095257088.png 2x"
    data-sizes="auto"
    alt="image-20230211095257088"
    title="image-20230211095257088" width="1030" height="48"/></p>
</li>
<li>
<p>展示： <code>lsmod | grep hello</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211095422286.png"
    data-srcset="/images/image-20230211095422286.png, /images/image-20230211095422286.png 1.5x, /images/image-20230211095422286.png 2x"
    data-sizes="auto"
    alt="image-20230211095422286"
    title="image-20230211095422286" width="1030" height="72"/></p>
</li>
<li>
<p>从内核中移除特定模块： <code>sudo rmmod hello</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211095626424.png"
    data-srcset="/images/image-20230211095626424.png, /images/image-20230211095626424.png 1.5x, /images/image-20230211095626424.png 2x"
    data-sizes="auto"
    alt="image-20230211095626424"
    title="image-20230211095626424" width="1030" height="49"/></p>
</li>
<li>
<p>查看模块运行时输出信息： <code>dmesg</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211095657475.png"
    data-srcset="/images/image-20230211095657475.png, /images/image-20230211095657475.png 1.5x, /images/image-20230211095657475.png 2x"
    data-sizes="auto"
    alt="image-20230211095657475"
    title="image-20230211095657475" width="973" height="80"/></p>
</li>
</ol>
<h3 id="b-implement-a-simple-firewall-using-netfilter">B: Implement a Simple Firewall Using Netfilter</h3>
<blockquote>
<p>Theory:
Netfilter is designed to facilitate the manipulation of packets by authorized users. It achieves this goal by implementing a number of hooks in the Linux kernel. These hooks are inserted into various places, including the packet incoming and outgoing paths. If we want to manipulate the incoming packets, we simply need to connect our own programs (within LKM) to the corresponding hooks. Once an incoming packet arrives, our program will be invoked.  Our program can decide whether this packet should be blocked or not; moreover, we can also modify the packets in the program.</p>
</blockquote>
<p>Task：Use LKM and Netfilter to implement a packet filtering module: This module will fetch the firewall policies from a data structure, and use the policies to decide whether packets should be blocked or not.</p>
<p>实验核心：将我们的函数(在内核模块中)挂接到相应的netfilter钩子上。，可拆解成如下3部分进行理解：</p>
<ul>
<li>Hooking to Netfilter</li>
<li>Hook functions</li>
<li>Blocking packets</li>
</ul>
<blockquote>
<p>简要说明可参考：<a href="https://seedsecuritylabs.org/Labs_20.04/Files/Firewall/Firewall.pdf"target="_blank" rel="external nofollow noopener noreferrer">实验手册</a></p>
</blockquote>
<h4 id="task1">Task1</h4>
<blockquote>
<p>task: Compile the sample code using the provided Makefile. Load it into the kernel, and demonstrate that the firewall is working as expected.</p>
</blockquote>
<ol>
<li>
<p>(样例)包过滤模块函数代码解析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter_ipv4.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/udp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="n">hook1</span><span class="p">,</span> <span class="n">hook2</span><span class="p">;</span><span class="c1">//定义两个netfilter类型钩子，准备好hook data structure
</span></span></span><span class="line"><span class="cl"><span class="c1">//阻止符合条件的udp数据包(钩子函数2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">blockUDP</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">u16</span>  <span class="n">port</span>   <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;8.8.8.8&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">u32</span>  <span class="n">ip_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//转换IP地址，从点分十进制格式(1.2.3.4)到32位二进制(0x01020304)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//它可以与存储在数据包中的二进制数进行比较。 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">in4_pton</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">udph</span> <span class="o">=</span> <span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//将目的IP地址和端口号与指定规则中的值进行比较 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">ip_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">)</span> <span class="o">==</span> <span class="n">port</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&#34;*** Dropping %pI4 (UDP), port %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="c1">//若匹配规则，则返回NF_DROP给netfilter, netfilter将丢弃数据包 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="c1">//否则，不匹配过滤规则，返回NF_ACCEPT，netfilter将放行数据包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//钩子1的钩子函数：打印包信息
</span></span></span><span class="line"><span class="cl"><span class="c1">//当netfilter调用钩子函数时，传入三个参数，其中skb是真实包指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">printInfo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="o">*</span><span class="n">hook</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="o">*</span><span class="n">protocol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//如何从状态参数中检索钩子号。 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hook</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_LOCAL_IN</span><span class="p">:</span>     <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;LOCAL_IN&#34;</span><span class="p">;</span>     <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_LOCAL_OUT</span><span class="p">:</span>    <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;LOCAL_OUT&#34;</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_PRE_ROUTING</span><span class="p">:</span>  <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;PRE_ROUTING&#34;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_POST_ROUTING</span><span class="p">:</span> <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;POST_ROUTING&#34;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_FORWARD</span><span class="p">:</span>      <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;FORWARD&#34;</span><span class="p">;</span>      <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">default</span><span class="o">:</span>                   <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;IMPOSSIBLE&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;*** %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hook</span><span class="p">);</span> <span class="c1">//打印钩子信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="c1">//获得IP头指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">switch</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_UDP</span><span class="p">:</span>  <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;UDP&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_TCP</span><span class="p">:</span>  <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;TCP&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_ICMP</span><span class="p">:</span> <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;ICMP&#34;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">default</span><span class="o">:</span>           <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;OTHER&#34;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//输出源和目的IP地址及协议
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;    %pI4  --&gt; %pI4 (%s)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">),</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//在该模块被加载后，调用此函数，注册两个hooks至netfilter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">registerFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Registering filters.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//设置hook data structure所需参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">hook1</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span><span class="c1">//钩子函数名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">hook1</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">;</span><span class="c1">//hook number (LOCAL_OUT hook)；钩子号是netfilter中5个钩子之一 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">hook1</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span><span class="c1">//准备好钩子的参数后，绑定至netfilter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//同理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">hook2</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">blockUDP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_POST_ROUTING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//移除内核模块时从netfilter注销过滤模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">removeFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;The filters are being removed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module_init</span><span class="p">(</span><span class="n">registerFilter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">module_exit</span><span class="p">(</span><span class="n">removeFilter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>利用Makefile编译代码成LKM，并将它加载进内核中。</p>
<p>MakeFile如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">+=</span> seedFilter.o
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
</span></span><span class="line"><span class="cl"><span class="nf">ins</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	sudo dmesg -C
</span></span><span class="line"><span class="cl">	sudo insmod seedFilter.ko
</span></span><span class="line"><span class="cl"><span class="nf">rm</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	sudo rmmod seedFilter
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211223848862.png"
    data-srcset="/images/image-20230211223848862.png, /images/image-20230211223848862.png 1.5x, /images/image-20230211223848862.png 2x"
    data-sizes="auto"
    alt="image-20230211223848862"
    title="image-20230211223848862" width="1035" height="466"/></p>
<p>进行加载：<code>sudo insmod seedFilter.ko</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211224230152.png"
    data-srcset="/images/image-20230211224230152.png, /images/image-20230211224230152.png 1.5x, /images/image-20230211224230152.png 2x"
    data-sizes="auto"
    alt="image-20230211224230152"
    title="image-20230211224230152" width="1035" height="53"/></p>
</li>
<li>
<p>验证防火墙起作用</p>
<p>利用 <code>dig @8.8.8.8 www.example.com</code> 生成UDP包至8.8.8.8(Google DNS服务器)</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211224719005.png"
    data-srcset="/images/image-20230211224719005.png, /images/image-20230211224719005.png 1.5x, /images/image-20230211224719005.png 2x"
    data-sizes="auto"
    alt="image-20230211224719005"
    title="image-20230211224719005" width="1035" height="203"/></p>
<p>通过上图可看出防火墙正常工作，请求已经被阻止了，超时不能到达。(若未工作，将会得到响应)</p>
<p>查看系统日志也可以发现LOCAL_OUT钩子已经起作用了，过滤模块对匹配规则的数据包进行了过滤：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230211235326346.png"
    data-srcset="/images/image-20230211235326346.png, /images/image-20230211235326346.png 1.5x, /images/image-20230211235326346.png 2x"
    data-sizes="auto"
    alt="image-20230211235326346"
    title="image-20230211235326346" width="1035" height="238"/></p>
</li>
</ol>
<h4 id="task2">Task2</h4>
<blockquote>
<p>Hook the printInfo function to all of the netfilter hooks. Using your experiment results to help explain at what condition will each of the hook function be invoked.</p>
</blockquote>
<p>钩子号的宏：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">NF_INET_PRE_ROUTING
</span></span><span class="line"><span class="cl">NF_INET_LOCAL_IN
</span></span><span class="line"><span class="cl">NF_INET_FORWARD
</span></span><span class="line"><span class="cl">NF_INET_LOCAL_OUT
</span></span><span class="line"><span class="cl">NF_INET_POST_ROUTING
</span></span></code></pre></td></tr></table>
</div>
</div><p>源码设计：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//Files/task1B2/test.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter_ipv4.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/udp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="n">hook1</span><span class="p">,</span> <span class="n">hook2</span><span class="p">,</span> <span class="n">hook3</span><span class="p">,</span> <span class="n">hook4</span><span class="p">,</span> <span class="n">hook5</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">printInfo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="o">*</span><span class="n">hook</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="o">*</span><span class="n">protocol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hook</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_LOCAL_IN</span><span class="p">:</span>     <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;LOCAL_IN&#34;</span><span class="p">;</span>     <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_LOCAL_OUT</span><span class="p">:</span>    <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;LOCAL_OUT&#34;</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_PRE_ROUTING</span><span class="p">:</span>  <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;PRE_ROUTING&#34;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_POST_ROUTING</span><span class="p">:</span> <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;POST_ROUTING&#34;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">NF_INET_FORWARD</span><span class="p">:</span>      <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;FORWARD&#34;</span><span class="p">;</span>      <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">     <span class="k">default</span><span class="o">:</span>                   <span class="n">hook</span> <span class="o">=</span> <span class="s">&#34;IMPOSSIBLE&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;*** %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hook</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">switch</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_UDP</span><span class="p">:</span>  <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;UDP&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_TCP</span><span class="p">:</span>  <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;TCP&#34;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nl">IPPROTO_ICMP</span><span class="p">:</span> <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;ICMP&#34;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">default</span><span class="o">:</span>           <span class="n">protocol</span> <span class="o">=</span> <span class="s">&#34;OTHER&#34;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Print out the IP addresses and protocol
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;    %pI4  --&gt; %pI4 (%s)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">),</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">registerFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Registering filters.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_POST_ROUTING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">hook3</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook3</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_PRE_ROUTING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook3</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook3</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">hook4</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook4</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook4</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook4</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">hook5</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">printInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook5</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_FORWARD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook5</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook5</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">removeFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;The filters are being removed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module_init</span><span class="p">(</span><span class="n">registerFilter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">module_exit</span><span class="p">(</span><span class="n">removeFilter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Makefile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">+=</span> test.o
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">ins</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	sudo dmesg -C
</span></span><span class="line"><span class="cl">	sudo insmod test.ko
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">rm</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	sudo rmmod <span class="nb">test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212102804088.png"
    data-srcset="/images/image-20230212102804088.png, /images/image-20230212102804088.png 1.5x, /images/image-20230212102804088.png 2x"
    data-sizes="auto"
    alt="image-20230212102804088"
    title="image-20230212102804088" width="1035" height="469"/></p>
<p>加载：<code>sudo insmod test.ko</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212102855163.png"
    data-srcset="/images/image-20230212102855163.png, /images/image-20230212102855163.png 1.5x, /images/image-20230212102855163.png 2x"
    data-sizes="auto"
    alt="image-20230212102855163"
    title="image-20230212102855163" width="1035" height="23"/></p>
<p>验证每个钩子函数被调用的条件：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212104135663.png"
    data-srcset="/images/image-20230212104135663.png, /images/image-20230212104135663.png 1.5x, /images/image-20230212104135663.png 2x"
    data-sizes="auto"
    alt="image-20230212104135663"
    title="image-20230212104135663" width="1035" height="389"/></p>
<p>通过分析上图系统日志，当LKM被加载后各个钩子函数调用情况：</p>
<p>首先本机地址是10.0.2.15，因此[17493.785998]当从本地想要发包至10.10.0.119时，LOCAL_OUT钩子被调用；从日志能看出，这个从本地产生的发往其他机器的包在经过LOCAL_OUT钩子后，随后还会[17493.786006]由POST_ROUTING钩子进行处理；[17493.783003]能分析出从外机(10.10.0.19)发往某个机器，途径本机在进入协议栈后立即触发PRE_ROUTING钩子(在任何路由判断之前)进行校验(区分LOCAL_IN)；最后[17493.793014]可以分析接收到的包经过路由判断，如果目的是本机，将触发此hook。</p>
<blockquote>
<p>可以用dig @8.8.8.8 <a href="https://www.example.com"target="_blank" rel="external nofollow noopener noreferrer">www.example.com</a>构造，同理可以观察到上述4个钩子被触发。</p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212111916230.png"
    data-srcset="/images/image-20230212111916230.png, /images/image-20230212111916230.png 1.5x, /images/image-20230212111916230.png 2x"
    data-sizes="auto"
    alt="image-20230212111916230"
    title="image-20230212111916230" width="1035" height="308"/></p>
<blockquote>
<p>注：对于触发FORWARD钩子，目前想到的方法应该是在路由器上进行设置，由于当时做的时候没用Container，因此暂未复现，有待补充。</p>
</blockquote>
<p>总结：</p>
<ul>
<li>NF_IP_PRE_ROUTING: 接收到的包进入协议栈立即触发此个hook</li>
<li>NF_IP_LOCAL_IN: 接收到的包经过路由判断，如果目的是本机，将触发此hook</li>
<li>NF_IP_FORWARD: 接收到的包经过路由判断，如果目的是其他机器，将触发此hook</li>
<li>NF_IP_LOCAL_OUT：本机产生的准备发送的包，在进入协议栈后立即触发此hook</li>
<li>NF_IP_POST_ROUTING: 本机产生的准备发送的包或者转发的包，在经过路由的判断之后，将触发此hook</li>
</ul>
<blockquote>
<p>参考：<a href="https://wendeng.github.io/2018/12/06/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3netfilter%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0/#2%E3%80%81Netfilter-Hooks"target="_blank" rel="external nofollow noopener noreferrer">深入理解netfilter的核心原理与实现</a></p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224080503134.png"
    data-srcset="/images/image-20230224080503134.png, /images/image-20230224080503134.png 1.5x, /images/image-20230224080503134.png 2x"
    data-sizes="auto"
    alt="image-20230224080503134"
    title="image-20230224080503134" width="1884" height="938"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/1623796-20210908161950970-1205139022.png"
    data-srcset="/images/1623796-20210908161950970-1205139022.png, /images/1623796-20210908161950970-1205139022.png 1.5x, /images/1623796-20210908161950970-1205139022.png 2x"
    data-sizes="auto"
    alt="img"
    title="img" width="842" height="662"/></p>
<h4 id="task3">Task3</h4>
<blockquote>
<p>Implement two more hooks to achieve the following: (1) preventing other computers to ping the VM, and (2) preventing other computers to telnet into the VM. Please implement two different hook functions, but register them to the same netfilter hook. You should decide what hook to use. Telnet’s default port is TCP port 23. To test it, you can start the containers, go to 10.9.0.5, run the following commands (10.9.0.1 is the IP address assigned to the VM; for the sake of simplicity, you can hardcode this IP address in your firewall rules).</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">ping 10.9.0.1
</span></span><span class="line"><span class="cl">telnet 10.9.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>防火墙代码实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//Files/task1B3/filter.c
</span></span></span><span class="line"><span class="cl"><span class="c1">//注释说明为什么挂载在LOCAL_IN：因为这两个需求的数据包均会从其它主机发往本机，因此必然会经过LOCAL_IN hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/netfilter_ipv4.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/udp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="n">hook1</span><span class="p">,</span><span class="n">hook2</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hook_func1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;10.9.0.1&#34;</span><span class="p">;</span><span class="c1">//simplicity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">u32</span>  <span class="n">ip_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">in4_pton</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span><span class="c1">//字符串转32位二进制地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_ICMP</span><span class="p">){</span><span class="c1">//filter ICMP Packet(ping)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&#34;*** Dropping %pI4 (ICMP/ping)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">           <span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Not ICMP</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hook_func2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;10.9.0.1&#34;</span><span class="p">;</span><span class="c1">//simplicity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">u32</span>  <span class="n">ip_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">in4_pton</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span> <span class="o">&amp;&amp;</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="mi">23</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">     			 <span class="c1">//过滤telnet连接，tcp且端口号23
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&#34;*** Dropping %pI4 (TCP/telnet)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">           <span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Not TCP</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">registerFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Registering filters.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//两个钩子函数挂在同一个挂载点NF_INET_LOCAL_IN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">hook1</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hook_func1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook1</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hook_func2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">hook2</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_FIRST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">removeFilter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="c1">//移除模块时执行，撤销钩子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;The filters are being removed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">nf_unregister_net_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hook2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module_init</span><span class="p">(</span><span class="n">registerFilter</span><span class="p">);</span><span class="c1">//初始化模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">module_exit</span><span class="p">(</span><span class="n">removeFilter</span><span class="p">);</span><span class="c1">//移除模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译成LKM：<code>make</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212133153744.png"
    data-srcset="/images/image-20230212133153744.png, /images/image-20230212133153744.png 1.5x, /images/image-20230212133153744.png 2x"
    data-sizes="auto"
    alt="image-20230212133153744"
    title="image-20230212133153744" width="1035" height="412"/></p>
<p>测试：</p>
<ol>
<li>
<p>启动容器，<code>docker-compose up -d</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212133350903.png"
    data-srcset="/images/image-20230212133350903.png, /images/image-20230212133350903.png 1.5x, /images/image-20230212133350903.png 2x"
    data-sizes="auto"
    alt="image-20230212133350903"
    title="image-20230212133350903" width="1035" height="180"/></p>
</li>
<li>
<p>进入hostA，<code>docksh 40</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212133540716.png"
    data-srcset="/images/image-20230212133540716.png, /images/image-20230212133540716.png 1.5x, /images/image-20230212133540716.png 2x"
    data-sizes="auto"
    alt="image-20230212133540716"
    title="image-20230212133540716" width="1035" height="205"/></p>
</li>
<li>
<p>在未装载LKM时，从hostA ping VM以及从hostA telnet VM</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212133642299.png"
    data-srcset="/images/image-20230212133642299.png, /images/image-20230212133642299.png 1.5x, /images/image-20230212133642299.png 2x"
    data-sizes="auto"
    alt="image-20230212133642299"
    title="image-20230212133642299" width="1035" height="386"/></p>
<p>均正常。</p>
</li>
<li>
<p>加载： <code>sudo insmod filter.ko</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212133818651.png"
    data-srcset="/images/image-20230212133818651.png, /images/image-20230212133818651.png 1.5x, /images/image-20230212133818651.png 2x"
    data-sizes="auto"
    alt="image-20230212133818651"
    title="image-20230212133818651" width="1035" height="56"/></p>
</li>
<li>
<p>再次重复步骤3，结果如下：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212134103774.png"
    data-srcset="/images/image-20230212134103774.png, /images/image-20230212134103774.png 1.5x, /images/image-20230212134103774.png 2x"
    data-sizes="auto"
    alt="image-20230212134103774"
    title="image-20230212134103774" width="1035" height="185"/></p>
<p>ping已经没有响应。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212134609018.png"
    data-srcset="/images/image-20230212134609018.png, /images/image-20230212134609018.png 1.5x, /images/image-20230212134609018.png 2x"
    data-sizes="auto"
    alt="image-20230212134609018"
    title="image-20230212134609018" width="935" height="101"/></p>
<p>telnet连接也是超时状态。已经反映了防火墙策略应该生效。</p>
</li>
<li>
<p>进一步查看系统日志：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212134311617.png"
    data-srcset="/images/image-20230212134311617.png, /images/image-20230212134311617.png 1.5x, /images/image-20230212134311617.png 2x"
    data-sizes="auto"
    alt="image-20230212134311617"
    title="image-20230212134311617" width="1035" height="335"/></p>
<p>可以发现防火墙策略确实已经工作，根据输出的日志信息已经将ping自己的数据包均过滤掉了。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230212134739186.png"
    data-srcset="/images/image-20230212134739186.png, /images/image-20230212134739186.png 1.5x, /images/image-20230212134739186.png 2x"
    data-sizes="auto"
    alt="image-20230212134739186"
    title="image-20230212134739186" width="935" height="102"/></p>
<p>telnet同理。</p>
</li>
</ol>
<p>对比日志输出信息，可以发现，由于上述两个钩子函数是挂同一个hook point上的(LOCAL_IN)，二者执行顺序的策略是NF_IP_PRI_FIRST，在此例中是过滤telnet连接数据包优先执行。</p>
<blockquote>
<p>netfilter允许在同一个hook上注册多个回调函数，并且可以指定不同的优先级。如果第一个函数接受了数据包，那么数据包会被传递给下一个优先级低的函数。如果数据包被一个回调函数丢弃了，那么后面的函数（如果存在）就不会被执行了。</p>
</blockquote>
<h2 id="task-2-experimenting-with-stateless-firewall-rules">Task 2: Experimenting with Stateless Firewall Rules</h2>
<h3 id="a-protecting-the-router">A: Protecting the Router</h3>
<p>目标：Set up rules to prevent outside machines from accessing the router machine, except ping.</p>
<p>实验：</p>
<ol>
<li>
<p>启动容器：<code>docker-compose up -d</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222232245463.png"
    data-srcset="/images/image-20230222232245463.png, /images/image-20230222232245463.png 1.5x, /images/image-20230222232245463.png 2x"
    data-sizes="auto"
    alt="image-20230222232245463"
    title="image-20230222232245463" width="935" height="334"/></p>
</li>
<li>
<p>进入router container：<code>docksh 84</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222232318005.png"
    data-srcset="/images/image-20230222232318005.png, /images/image-20230222232318005.png 1.5x, /images/image-20230222232318005.png 2x"
    data-sizes="auto"
    alt="image-20230222232318005"
    title="image-20230222232318005" width="935" height="50"/></p>
</li>
<li>
<p>执行如下iptables命令建立防火墙规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -P OUTPUT DROP ➙Set default rule <span class="k">for</span> OUTPUT
</span></span><span class="line"><span class="cl">iptables -P INPUT DROP ➙Set default rule <span class="k">for</span> INPUT
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222232708840.png"
    data-srcset="/images/image-20230222232708840.png, /images/image-20230222232708840.png 1.5x, /images/image-20230222232708840.png 2x"
    data-sizes="auto"
    alt="image-20230222232708840"
    title="image-20230222232708840" width="1077" height="157"/></p>
</li>
<li>
<p>进入10.9.0.5container：<code>docksh 40</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222232849112.png"
    data-srcset="/images/image-20230222232849112.png, /images/image-20230222232849112.png 1.5x, /images/image-20230222232849112.png 2x"
    data-sizes="auto"
    alt="image-20230222232849112"
    title="image-20230222232849112" width="1077" height="52"/></p>
</li>
<li>
<p>从10.9.0.5 ping router：<code>ping 10.9.0.11</code>能够ping通。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222233028131.png"
    data-srcset="/images/image-20230222233028131.png, /images/image-20230222233028131.png 1.5x, /images/image-20230222233028131.png 2x"
    data-sizes="auto"
    alt="image-20230222233028131"
    title="image-20230222233028131" width="1077" height="366"/></p>
</li>
<li>
<p>从10.9.0.5 telnet router：<code>telnet 10.9.0.11</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230222233424293.png"
    data-srcset="/images/image-20230222233424293.png, /images/image-20230222233424293.png 1.5x, /images/image-20230222233424293.png 2x"
    data-sizes="auto"
    alt="image-20230222233424293"
    title="image-20230222233424293" width="1077" height="108"/></p>
<p>发现连接超时，telnet未成功。</p>
</li>
<li>
<p>解释每条规则的含义</p>
<ul>
<li>第一条对filter表(默认)的INPUT链追加一条规则：对发往本地的ICMP包的echo-request类型均accept放行。</li>
<li>第二条对filter表(默认)的OUTPUT链追加一条规则：对从本地发出的ICMP包的echo-reply类型均accept放行。</li>
<li>第三条设置输出策略为DROP，也就是拒绝所有的输出流量即系统不能发送任何数据包的到外部。默认策略。</li>
<li>第四条设置输入策略为DROP，也就是拒绝所有的输入流量即系统不能接受任何外部数据包。默认策略。</li>
</ul>
<p>上述ping能成功，icmp输入输出流量均正常是因为前两条规则覆盖了默认策略。</p>
</li>
<li>
<p>清空前述策略，恢复至初始状态进入下一个任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -F
</span></span><span class="line"><span class="cl">iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">iptables -P INPUT ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223001030135.png"
    data-srcset="/images/image-20230223001030135.png, /images/image-20230223001030135.png 1.5x, /images/image-20230223001030135.png 2x"
    data-sizes="auto"
    alt="image-20230223001030135"
    title="image-20230223001030135" width="1077" height="103"/></p>
<blockquote>
<p>当然也可以直接重启容器：<code>docker restart &lt;Container ID&gt;</code></p>
</blockquote>
</li>
</ol>
<p><strong>补充：</strong></p>
<p>-P是iptables的一个选项，它的全称是–policy。它用来设置iptables的默认策略，也就是当没有规则匹配一个数据包时，应该采取什么动作。你可以为每个链（chain）设置不同的默认策略，例如INPUT、OUTPUT或FORWARD。默认策略通常有两种选择：ACCEPT或DROP。ACCEPT表示允许数据包通过，DROP表示拒绝数据包通过。</p>
<p>-F是iptables的一个选项，它的全称是–flush。它用来删除所有的规则，也就是清空iptables的表（table）。这样的话，你的iptables就会恢复到初始状态，只有默认策略起作用。如果你想删除某个特定的链（chain）的规则，你可以指定链的名字，例如INPUT、OUTPUT或FORWARD。</p>
<h3 id="b-protecting-the-internal-network">B: Protecting the Internal Network</h3>
<p>目标：Set up firewall rules on the router to protect the internal network 192.168.60.0/24</p>
<blockquote>
<p>使用FORWARD链</p>
</blockquote>
<p>主要是对ICMP流量实施以下限制：</p>
<ol>
<li>
<p>外部主机无法ping通内部主机。</p>
</li>
<li>
<p>外部主机可以ping通路由器。</p>
</li>
<li>
<p>内部主机可以ping外部主机。</p>
</li>
<li>
<p>内部网络和外部网络之间的所有其他数据包都应该被阻止</p>
</li>
</ol>
<p>实验：</p>
<ol>
<li>
<p>启动容器并进入router</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223080437547.png"
    data-srcset="/images/image-20230223080437547.png, /images/image-20230223080437547.png 1.5x, /images/image-20230223080437547.png 2x"
    data-sizes="auto"
    alt="image-20230223080437547"
    title="image-20230223080437547" width="994" height="362"/></p>
</li>
<li>
<p>构建防火墙</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -A FORWARD -s 192.168.60.0/24 -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -A FORWARD -d 192.168.60.0/24 -p icmp --icmp-type echo-reply -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -A FORWARD -p icmp --icmp-type echo-request -j DROP
</span></span><span class="line"><span class="cl">iptables -P FORWARD DROP
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223084300068.png"
    data-srcset="/images/image-20230223084300068.png, /images/image-20230223084300068.png 1.5x, /images/image-20230223084300068.png 2x"
    data-sizes="auto"
    alt="image-20230223084300068"
    title="image-20230223084300068" width="1453" height="130"/></p>
</li>
<li>
<p>测试</p>
<ul>
<li>外部主机无法ping通内部主机：进入hostA ping内网主机，可以发现长时间无响应。</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223082305768.png"
    data-srcset="/images/image-20230223082305768.png, /images/image-20230223082305768.png 1.5x, /images/image-20230223082305768.png 2x"
    data-sizes="auto"
    alt="image-20230223082305768"
    title="image-20230223082305768" width="1034" height="210"/></p>
<ul>
<li>外部主机可以ping通路由器：仍然利用hostA，ping路由器，可以发现能够ping通。</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223082348708.png"
    data-srcset="/images/image-20230223082348708.png, /images/image-20230223082348708.png 1.5x, /images/image-20230223082348708.png 2x"
    data-sizes="auto"
    alt="image-20230223082348708"
    title="image-20230223082348708" width="1034" height="320"/></p>
<ul>
<li>内部主机可以ping外部主机：进入host1，ping hostA，可以ping通。</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223084357316.png"
    data-srcset="/images/image-20230223084357316.png, /images/image-20230223084357316.png 1.5x, /images/image-20230223084357316.png 2x"
    data-sizes="auto"
    alt="image-20230223084357316"
    title="image-20230223084357316" width="1453" height="297"/></p>
<ul>
<li>内部网络和外部网络之间的所有其他数据包都应该被阻止：从host1 telnet hostA以及从hostA telnet host1，均超时无法成功。</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223084758147.png"
    data-srcset="/images/image-20230223084758147.png, /images/image-20230223084758147.png 1.5x, /images/image-20230223084758147.png 2x"
    data-sizes="auto"
    alt="image-20230223084758147"
    title="image-20230223084758147" width="1453" height="109"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223085154591.png"
    data-srcset="/images/image-20230223085154591.png, /images/image-20230223085154591.png 1.5x, /images/image-20230223085154591.png 2x"
    data-sizes="auto"
    alt="image-20230223085154591"
    title="image-20230223085154591" width="1453" height="105"/></p>
</li>
<li>
<p>清空规则，开始下一个任务。</p>
</li>
</ol>
<h3 id="c-protecting-internal-servers">C: Protecting Internal Servers</h3>
<p>目标：</p>
<ol>
<li>
<p>所有内部主机都运行一个telnet服务器(监听端口23)。外部主机只能访问位于192.168.60.5的telnet服务器，而不是其他内部主机。</p>
</li>
<li>
<p>外部主机无法访问其他内部服务器。</p>
</li>
<li>
<p>内部主机可以访问所有内部服务器。</p>
</li>
<li>
<p>内部主机无法访问外部服务器。</p>
</li>
<li>
<p>在此任务中，不允许使用连接跟踪机制。它将在后面的任务中使用。</p>
</li>
</ol>
<p>实验：</p>
<ol>
<li>
<p>启动容器</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223194949125.png"
    data-srcset="/images/image-20230223194949125.png, /images/image-20230223194949125.png 1.5x, /images/image-20230223194949125.png 2x"
    data-sizes="auto"
    alt="image-20230223194949125"
    title="image-20230223194949125" width="887" height="366"/></p>
</li>
<li>
<p>构建防火墙规则，施加在路由器上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -A FORWARD -i eth0 -p tcp --dport <span class="m">23</span> -d 192.168.60.5 -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -A FORWARD -i eth0 -p tcp --dport <span class="m">23</span> -j DROP
</span></span><span class="line"><span class="cl">iptables -A FORWARD -i eth1 -p tcp --dport <span class="m">23</span> -j DROP
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223202255875.png"
    data-srcset="/images/image-20230223202255875.png, /images/image-20230223202255875.png 1.5x, /images/image-20230223202255875.png 2x"
    data-sizes="auto"
    alt="image-20230223202255875"
    title="image-20230223202255875" width="1043" height="126"/></p>
</li>
<li>
<p>测试</p>
<ul>
<li>外部主机只能访问位于192.168.60.5的telnet服务器: 从hostA访问host1</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223202346893.png"
    data-srcset="/images/image-20230223202346893.png, /images/image-20230223202346893.png 1.5x, /images/image-20230223202346893.png 2x"
    data-sizes="auto"
    alt="image-20230223202346893"
    title="image-20230223202346893" width="614" height="160"/></p>
<ul>
<li>外部主机无法访问其他内部服务器：从hostA访问host2,host3</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223202703037.png"
    data-srcset="/images/image-20230223202703037.png, /images/image-20230223202703037.png 1.5x, /images/image-20230223202703037.png 2x"
    data-sizes="auto"
    alt="image-20230223202703037"
    title="image-20230223202703037" width="962" height="119"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223203022106.png"
    data-srcset="/images/image-20230223203022106.png, /images/image-20230223203022106.png 1.5x, /images/image-20230223203022106.png 2x"
    data-sizes="auto"
    alt="image-20230223203022106"
    title="image-20230223203022106" width="962" height="101"/></p>
<ul>
<li>内部主机可以访问所有内部服务器：</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223203115864.png"
    data-srcset="/images/image-20230223203115864.png, /images/image-20230223203115864.png 1.5x, /images/image-20230223203115864.png 2x"
    data-sizes="auto"
    alt="image-20230223203115864"
    title="image-20230223203115864" width="962" height="336"/></p>
<ul>
<li>内部主机无法访问外部服务器：host1访问hostA</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223203416236.png"
    data-srcset="/images/image-20230223203416236.png, /images/image-20230223203416236.png 1.5x, /images/image-20230223203416236.png 2x"
    data-sizes="auto"
    alt="image-20230223203416236"
    title="image-20230223203416236" width="962" height="115"/></p>
</li>
<li>
<p>清空规则，开始下一个任务。</p>
</li>
</ol>
<h2 id="task-3-connection-tracking-and-stateful-firewall">Task 3: Connection Tracking and Stateful Firewall</h2>
<h3 id="a-experiment-with-the-connection-tracking">A: Experiment with the Connection Tracking</h3>
<blockquote>
<p>Tracking connections is achieved by the conntrack mechanism inside the kernel.</p>
</blockquote>
<p>实验：</p>
<ol>
<li>
<p>ICMP实验</p>
<p>在hostA ping host1：<code>ping 192.168.60.5</code></p>
<p>在Router上检查连接追踪信息：<code>conntrack -L</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223204400587.png"
    data-srcset="/images/image-20230223204400587.png, /images/image-20230223204400587.png 1.5x, /images/image-20230223204400587.png 2x"
    data-sizes="auto"
    alt="image-20230223204400587"
    title="image-20230223204400587" width="1037" height="106"/></p>
<p>ICMP连接状态大约会被保留30秒左右。</p>
</li>
<li>
<p>UDP实验</p>
<p>在192.168.60.5建立一个UDP服务器：<code>nc -lu 9090</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223204827566.png"
    data-srcset="/images/image-20230223204827566.png, /images/image-20230223204827566.png 1.5x, /images/image-20230223204827566.png 2x"
    data-sizes="auto"
    alt="image-20230223204827566"
    title="image-20230223204827566" width="1037" height="65"/></p>
<p>在10.9.0.5发送UDP包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc -u 192.168.60.5 <span class="m">9090</span>
</span></span><span class="line"><span class="cl">&lt;<span class="nb">type</span> something, <span class="k">then</span> hit <span class="k">return</span>&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223205100442.png"
    data-srcset="/images/image-20230223205100442.png, /images/image-20230223205100442.png 1.5x, /images/image-20230223205100442.png 2x"
    data-sizes="auto"
    alt="image-20230223205100442"
    title="image-20230223205100442" width="1037" height="109"/></p>
<p>在服务器主机上可以看到发送的UDP包内容：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223205211059.png"
    data-srcset="/images/image-20230223205211059.png, /images/image-20230223205211059.png 1.5x, /images/image-20230223205211059.png 2x"
    data-sizes="auto"
    alt="image-20230223205211059"
    title="image-20230223205211059" width="750" height="159"/></p>
<p>在Router上检查连接追踪信息：<code>conntrack -L</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223205422400.png"
    data-srcset="/images/image-20230223205422400.png, /images/image-20230223205422400.png 1.5x, /images/image-20230223205422400.png 2x"
    data-sizes="auto"
    alt="image-20230223205422400"
    title="image-20230223205422400" width="1043" height="106"/></p>
<p>UDP连接状态大约也会被保留30秒左右。</p>
</li>
<li>
<p>TCP实验</p>
<p>在192.168.60.5建立一个TCP服务器：<code>nc -l 9090</code></p>
<p>在10.9.0.5发送TCP包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nc 192.168.60.5 <span class="m">9090</span>
</span></span><span class="line"><span class="cl">&lt;<span class="nb">type</span> something, <span class="k">then</span> hit <span class="k">return</span>&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223210115514.png"
    data-srcset="/images/image-20230223210115514.png, /images/image-20230223210115514.png 1.5x, /images/image-20230223210115514.png 2x"
    data-sizes="auto"
    alt="image-20230223210115514"
    title="image-20230223210115514" width="1043" height="66"/></p>
<p>在服务器主机上可以看到发送的TCP包内容：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223210140522.png"
    data-srcset="/images/image-20230223210140522.png, /images/image-20230223210140522.png 1.5x, /images/image-20230223210140522.png 2x"
    data-sizes="auto"
    alt="image-20230223210140522"
    title="image-20230223210140522" width="1043" height="66"/></p>
<p>在Router上检查连接追踪信息：<code>conntrack -L</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223210347319.png"
    data-srcset="/images/image-20230223210347319.png, /images/image-20230223210347319.png 1.5x, /images/image-20230223210347319.png 2x"
    data-sizes="auto"
    alt="image-20230223210347319"
    title="image-20230223210347319" width="1043" height="98"/></p>
<p>TCP连接自身无时间限制，直到有一方关闭连接。</p>
</li>
</ol>
<h3 id="b-setting-up-a-stateful-firewall">B: Setting Up a Stateful Firewall</h3>
<p>任务：Rewrite the firewall rules in Task 2.C, but this time, we will add a rule allowing internal hosts to visit any external server (this was not allowed in Task 2.C).</p>
<p>实验：</p>
<ol>
<li>
<p>启动容器</p>
</li>
<li>
<p>构建防火墙</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -A FORWARD -i eth0 -p tcp --dport <span class="m">23</span> --syn -d 192.168.60.5 -m conntrack --ctstate NEW -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -A FORWARD -i eth1 -p tcp  --syn -m conntrack --ctstate NEW -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -A FORWARD -p tcp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -A FORWARD -p tcp -j DROP
</span></span><span class="line"><span class="cl">iptables -P FORWARD ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224002139582.png"
    data-srcset="/images/image-20230224002139582.png, /images/image-20230224002139582.png 1.5x, /images/image-20230224002139582.png 2x"
    data-sizes="auto"
    alt="image-20230224002139582"
    title="image-20230224002139582" width="1107" height="227"/></p>
</li>
<li>
<p>测试</p>
<ul>
<li>外部主机只能访问位于192.168.60.5的telnet服务器: 从hostA访问host1</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223221516524.png"
    data-srcset="/images/image-20230223221516524.png, /images/image-20230223221516524.png 1.5x, /images/image-20230223221516524.png 2x"
    data-sizes="auto"
    alt="image-20230223221516524"
    title="image-20230223221516524" width="955" height="161"/></p>
<ul>
<li>外部主机无法访问其他内部服务器：从hostA访问host2,host3</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223222253985.png"
    data-srcset="/images/image-20230223222253985.png, /images/image-20230223222253985.png 1.5x, /images/image-20230223222253985.png 2x"
    data-sizes="auto"
    alt="image-20230223222253985"
    title="image-20230223222253985" width="955" height="108"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223222605555.png"
    data-srcset="/images/image-20230223222605555.png, /images/image-20230223222605555.png 1.5x, /images/image-20230223222605555.png 2x"
    data-sizes="auto"
    alt="image-20230223222605555"
    title="image-20230223222605555" width="955" height="103"/></p>
<ul>
<li>内部主机可以访问所有内部服务器：</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223222636398.png"
    data-srcset="/images/image-20230223222636398.png, /images/image-20230223222636398.png 1.5x, /images/image-20230223222636398.png 2x"
    data-sizes="auto"
    alt="image-20230223222636398"
    title="image-20230223222636398" width="955" height="313"/></p>
<ul>
<li>内部主机可以访问外部服务器：</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224002230530.png"
    data-srcset="/images/image-20230224002230530.png, /images/image-20230224002230530.png 1.5x, /images/image-20230224002230530.png 2x"
    data-sizes="auto"
    alt="image-20230224002230530"
    title="image-20230224002230530" width="1107" height="207"/></p>
</li>
<li>
<p>清空规则，开始下一个任务。</p>
</li>
</ol>
<h2 id="task-4-limiting-network-traffic">Task 4: Limiting Network Traffic</h2>
<blockquote>
<p>In this task, we will use limit module to limit how many packets from 10.9.0.5 are allowed to get into the internal network.</p>
</blockquote>
<p>实验：</p>
<ol>
<li>
<p>启动容器</p>
</li>
<li>
<p>在路由器上配置防火墙</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -A FORWARD -s 10.9.0.5 -m limit --limit 10/minute --limit-burst <span class="m">5</span> -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -A FORWARD -s 10.9.0.5 -j DROP
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223224701337.png"
    data-srcset="/images/image-20230223224701337.png, /images/image-20230223224701337.png 1.5x, /images/image-20230223224701337.png 2x"
    data-sizes="auto"
    alt="image-20230223224701337"
    title="image-20230223224701337" width="1030" height="104"/></p>
</li>
<li>
<p>从10.9.0.5 ping 192.168.60.5</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223225057940.png"
    data-srcset="/images/image-20230223225057940.png, /images/image-20230223225057940.png 1.5x, /images/image-20230223225057940.png 2x"
    data-sizes="auto"
    alt="image-20230223225057940"
    title="image-20230223225057940" width="975" height="646"/></p>
</li>
<li>
<p>去除第二条规则，再次ping</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223225152031.png"
    data-srcset="/images/image-20230223225152031.png, /images/image-20230223225152031.png 1.5x, /images/image-20230223225152031.png 2x"
    data-sizes="auto"
    alt="image-20230223225152031"
    title="image-20230223225152031" width="975" height="516"/></p>
</li>
<li>
<p>分析</p>
<p>第一个iptables规则意味着来自10.9.0.5的数据包将被FORWARD链以每分钟10个的速率限制接受，突发流量限制为5个。第二条规则意味着来自10.9.0.5的任何其他数据包将被FORWARD链丢弃。</p>
<p>在有第二条规则时，观察上图，从10.9.0.5 ping 192.168.60.5，会发现一些数据包传输成功，一些数据包丢失，这取决于发送它们的速度。</p>
<p>没有第二条规则时，那来自10.9.0.5的所有数据包将被FORWARD链接受，没有任何速率限制或丢弃操作。</p>
<p>因此如果想对来自10.9.0.5的数据包实施严格的速率限制，并防止任何多余的流量通过FORWARD链，则需要第二个规则。</p>
</li>
</ol>
<blockquote>
<p>清空规则</p>
</blockquote>
<h2 id="task-5-load-balancing">Task 5: Load Balancing</h2>
<blockquote>
<p>In this task, we will use it to load balance three UDP servers running in the internal network.</p>
</blockquote>
<p>实验：</p>
<p>使用nth模块：</p>
<ol>
<li>
<p>在host1，host2，host3中开启UDP服务器：<code>nc -luk 8080</code></p>
</li>
<li>
<p>在路由器配置如下规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode nth --every <span class="m">3</span> --packet <span class="m">0</span> -j DNAT --to-destination 192.168.60.5:8080
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223230807814.png"
    data-srcset="/images/image-20230223230807814.png, /images/image-20230223230807814.png 1.5x, /images/image-20230223230807814.png 2x"
    data-sizes="auto"
    alt="image-20230223230807814"
    title="image-20230223230807814" width="1102" height="73"/></p>
</li>
<li>
<p>在10.9.0.5发包观察：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">echo</span> hello <span class="p">|</span> nc -u 10.9.0.11 <span class="m">8080</span>
</span></span><span class="line"><span class="cl">&lt;hit Ctrl-C&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223231355649.png"
    data-srcset="/images/image-20230223231355649.png, /images/image-20230223231355649.png 1.5x, /images/image-20230223231355649.png 2x"
    data-sizes="auto"
    alt="image-20230223231355649"
    title="image-20230223231355649" width="773" height="53"/>即该规则是配置了当发送一个UDP包到路由器的8080端口时，会看到每三个包中第一个会到达192.168.60.5。</p>
</li>
<li>
<p>继续配置路由器规则，增加如下两条：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode nth --every <span class="m">2</span> --packet <span class="m">0</span> -j DNAT --to-destination 192.168.60.6:8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode nth --every <span class="m">1</span> --packet <span class="m">0</span> -j DNAT --to-destination 192.168.60.7:8080
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230223235642439.png"
    data-srcset="/images/image-20230223235642439.png, /images/image-20230223235642439.png 1.5x, /images/image-20230223235642439.png 2x"
    data-sizes="auto"
    alt="image-20230223235642439"
    title="image-20230223235642439" width="1106" height="177"/></p>
</li>
<li>
<p>发包观察三个服务器收到包的情况</p>
<p>连续发送三次，可以观察到第一次的包被分发到了192.168.60.5，第二次的包被分发到了192.168.60.6，第三次的包被分发到了192.168.60.7，往后随着次数增加，每三个包中第一个都是到host1，每2个的第一个是host2，最后一个是host3，实现负载均衡。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224000330750.png"
    data-srcset="/images/image-20230224000330750.png, /images/image-20230224000330750.png 1.5x, /images/image-20230224000330750.png 2x"
    data-sizes="auto"
    alt="image-20230224000330750"
    title="image-20230224000330750" width="1006" height="173"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224000350139.png"
    data-srcset="/images/image-20230224000350139.png, /images/image-20230224000350139.png 1.5x, /images/image-20230224000350139.png 2x"
    data-sizes="auto"
    alt="image-20230224000350139"
    title="image-20230224000350139" width="877" height="87"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224000359808.png"
    data-srcset="/images/image-20230224000359808.png, /images/image-20230224000359808.png 1.5x, /images/image-20230224000359808.png 2x"
    data-sizes="auto"
    alt="image-20230224000359808"
    title="image-20230224000359808" width="877" height="87"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224000410048.png"
    data-srcset="/images/image-20230224000410048.png, /images/image-20230224000410048.png 1.5x, /images/image-20230224000410048.png 2x"
    data-sizes="auto"
    alt="image-20230224000410048"
    title="image-20230224000410048" width="877" height="87"/></p>
</li>
</ol>
<p>即三个服务器流量相同，符合实验目的，负载均衡。</p>
<p>使用random模块：</p>
<ol>
<li>
<p>清空前述规则</p>
</li>
<li>
<p>路由器上配置规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode random --probability 0.3333 -j DNAT --to-destination 192.168.60.5:8080
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在10.9.0.5发包观察：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">echo</span> hello <span class="p">|</span> nc -u 10.9.0.11 <span class="m">8080</span>
</span></span><span class="line"><span class="cl">&lt;hit Ctrl-C&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224000958076.png"
    data-srcset="/images/image-20230224000958076.png, /images/image-20230224000958076.png 1.5x, /images/image-20230224000958076.png 2x"
    data-sizes="auto"
    alt="image-20230224000958076"
    title="image-20230224000958076" width="883" height="145"/></p>
<p>可以看到该包被分配到了192.168.60.5，实际上是有1/3的概率。</p>
</li>
<li>
<p>继续配置路由器规则，增加如下两条：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode random --probability 0.3333 -j DNAT --to-destination 192.168.60.6:8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p udp --dport <span class="m">8080</span> -m statistic --mode random --probability 0.3333 -j DNAT --to-destination 192.168.60.7:8080
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224001213613.png"
    data-srcset="/images/image-20230224001213613.png, /images/image-20230224001213613.png 1.5x, /images/image-20230224001213613.png 2x"
    data-sizes="auto"
    alt="image-20230224001213613"
    title="image-20230224001213613" width="1106" height="175"/></p>
</li>
<li>
<p>发包观察三个服务器收到包的情况</p>
<p>同样连续发送三次，可以观察到每个服务器都被分发到了一个，因为当前一共有3个服务器，每个被分发的概率是0.3333，因此每个服务器被分发的概率基本是相同的，总体上分发的流量也相同，实现负载均衡。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224001519423.png"
    data-srcset="/images/image-20230224001519423.png, /images/image-20230224001519423.png 1.5x, /images/image-20230224001519423.png 2x"
    data-sizes="auto"
    alt="image-20230224001519423"
    title="image-20230224001519423" width="763" height="154"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224001529666.png"
    data-srcset="/images/image-20230224001529666.png, /images/image-20230224001529666.png 1.5x, /images/image-20230224001529666.png 2x"
    data-sizes="auto"
    alt="image-20230224001529666"
    title="image-20230224001529666" width="763" height="154"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/images/image-20230224001538967.png"
    data-srcset="/images/image-20230224001538967.png, /images/image-20230224001538967.png 1.5x, /images/image-20230224001538967.png 2x"
    data-sizes="auto"
    alt="image-20230224001538967"
    title="image-20230224001538967" width="763" height="154"/></p>
<p>(清空规则)</p>
</li>
</ol>
<p>即三个服务器流量基本相同，符合实验目的，负载均衡。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-02-24&#32;00:00:00>更新于 2023-02-24&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E5%AE%9E%E9%AA%8C/' class="post-tag">网络安全攻防实验</a><a href='/tags/network/' class="post-tag">Network</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/rsa-public-key-encryption-and-signature-lab/" class="post-nav-item" rel="prev" title="RSA公钥加密和数字签名实验"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>RSA公钥加密和数字签名实验</a>
      <a href="/posts/secure_intelligent_traffic_light_control_using_fog_computing/" class="post-nav-item" rel="next" title="[2018|FGCS]Secure intelligent traffic light control using fog computing">[2018|FGCS]Secure intelligent traffic light control using fog computing<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/LaneGong"target="_blank" rel="external nofollow noopener noreferrer">Lane Gong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i>&nbsp;<span class="run-times">网站运行中 ...</span></span></div><div class="footer-line ibruce">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"","algoliaIndex":"","algoliaSearchKey":"","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":30,"type":"algolia"},"siteTime":"2022-11-23T15:00:00+08:00"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
